#!/bin/bash

function is_node_running {
    if [ -f ${OPENSHIFT_NODEDIY_DIR}/maintenance.pid ]; then
        exit 0
    fi
    if [ -f ${OPENSHIFT_NODEDIY_DIR}/server.pid ]; then
        exit 0
    fi
    ps axco command | grep -w '^node$' > /dev/null
}

function status() {
    client_message "Status:"
    node_ver=$(node -v)
    client_message "Node version: ${node_ver}"
    npm_ver=$(npm -v)
    client_message "NPM version: ${npm_ver}"

    if [ is_node_running ]; then
      client_message "Node is running."
    else
      client_message "Node is not running."
    fi
}

function start() {
    echo "Stopping maintenance web server."
    kill -9 `cat ${OPENSHIFT_NODEDIY_DIR}/maintenance.pid`
    rm -f ${OPENSHIFT_NODEDIY_DIR}/maintenance.pid

    logf="$OPENSHIFT_NODEJS_LOG_DIR/node.log"
    if [ -f "${OPENSHIFT_REPO_DIR}package.json" ]; then
        cd ${OPENSHIFT_REPO_DIR}
        client_message "Starting node using npm start"
        nohup npm start >> $logf 2>&1 &
        npm_pid=$!;
        sleep 3
        node_pid=$(pgrep -P $npm_pid)
        echo "$npm_pid $node_pid" > ${OPENSHIFT_NODEDIY_DIR}/server.pid
    else
        client_message "npm start requires a package.json file, and we could not find one."
    fi
}

function stop() {
    if [ is_node_running ]; then
      client_message "Stopping node"
      kill -9 `cat ${OPENSHIFT_NODEDIY_DIR}/server.pid`
      rm -f ${OPENSHIFT_NODEDIY_DIR}/server.pid
    else
      client_message "Could not stop node... Is it running?"
    fi

    client_message "Starting maintenance web server."
    nohup node ${OPENSHIFT_NODEDIY_DIR}/maintenance/maintenance.js > /tmp/nohup.out 2>&1&
    echo $! > ${OPENSHIFT_NODEDIY_DIR}/maintenance.pid
}

function restart() {
    stop
    start
}

function reload() {
    source "${OPENSHIFT_NODEDIY_DIR}lib/util"
    client_message "Reloading cartridge"
    install
    client_message "Restarting cartridge"
    restart
}

function tidy() {
  client_message "Emptying log dir: $OPENSHIFT_NODEJS_LOG_DIR"
  shopt -s dotglob
  rm -rf $OPENSHIFT_NODEJS_LOG_DIR/*
  rm -rf ${OPENSHIFT_NODEJS_DIR}tmp/*
}

#
#  main():
#

# Ensure arguments.
if ! [ $# -eq 1 ]; then
    echo "Usage: $0 [start|restart|graceful|graceful-stop|stop|status]"
    exit 1
fi

# Source utility functions.
source $OPENSHIFT_CARTRIDGE_SDK_BASH

# Handle commands.
case "$1" in
    start)               start       ;;
    restart|graceful)    restart     ;;
    graceful-stop|stop)  stop        ;;
    status)              status      ;;
    reload)              reload      ;;
    tidy)                tidy        ;;
    *) exit 0;
esac

